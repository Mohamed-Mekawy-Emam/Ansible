---
- name: test postgresql.auto.conf
  hosts: all
  become: yes
  become_user: root
  
  tasks:
    - name: Check for running recovery
      stat:
        path: /home/memam/Ansible/Ansible/postgres/data/standby.signal
      register: recovery_stat

    - name: Sync with the primary if recovery not in place
      block:
              # - name: Remove current data directory
              #   file:
              #     path: /home/memam/Ansible/Ansible/postgres/data
              #     state: absent
      - name: Create recovery file
        copy:
          dest: /home/memam/Ansible/Ansible/postgres/data/postgresql.auto.conf
          content: |
            # Do not edit this file manually!
            # It will be overwritten by the ALTER SYSTEM command.
            primary_conninfo = 'host={{ ansible_local }} user=repl application_name={{ ansible_hostname }}'
          mode: 0600
          owner: memam
          group: memam

      - name: Check for postgresql.conf file, if exist
        stat:
          path: /home/memam/Ansible/Ansible/postgres/data/postgresql.conf
        register: postgresqlconf_stat

      - name: Create config file symlink                         # This task can be removed if we will depend on master postgresql.conf file
        file:
          src: /home/memam/Ansible/Ansible/postgres/postgresql.conf.base
          dest: /home/memam/Ansible/Ansible/postgres/data/postgresql.conf
          state: link
          owner: memam
          group: memam
        when: postgresqlconf_stat.stat.exists == False
        
      when: recovery_stat.stat.exists == False
